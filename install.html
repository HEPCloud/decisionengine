

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installing and running HEPCloud’s Decision Engine on EL9 &mdash; decisionengine 2.0.6rc2.dev8+gc1fabaf10 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=6bbe7bbc"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installing and running HEPCloud’s Decision Engine" href="install_el7.html" />
    <link rel="prev" title="Release 1.1.0" href="release_notes/release_notes_1.1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            decisionengine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html">Release 2.0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html#release-2-0-4">Release 2.0.4</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html#release-2-0-3">Release 2.0.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html#release-2-0-2">Release 2.0.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html#release-2-0-1">Release 2.0.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes/release_notes_2.0.html#release-2-0-0">Release 2.0.0</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installing and running HEPCloud’s Decision Engine on EL9</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install-decision-engine-and-the-standard-modules">Install Decision Engine and the standard modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fix-the-glideinwms-frontend-installation">Fix the GlideinWMS Frontend installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-up-postgresql">Set up PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#install-redis">Install Redis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test">Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-decision-engine">Configure Decision Engine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#selecting-your-datasource">Selecting your datasource</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#start-decision-engine">Start decision engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stop-decision-engine">Stop decision engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-channels-to-decision-engine">Add channels to decision engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-pressure-based-pilot-submission">Setup pressure-based pilot submission</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install_el7.html">Installing and running HEPCloud’s Decision Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_el8.html">Installing and running HEPCloud’s Decision Engine on EL8</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="jenkins.html">Decisionengine CI with Jenkins pipeline</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code/index.html">Code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="code/decisionengine.html">decisionengine package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">decisionengine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Installing and running HEPCloud’s Decision Engine on EL9</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/install.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installing-and-running-hepcloud-s-decision-engine-on-el9">
<h1>Installing and running HEPCloud’s Decision Engine on EL9<a class="headerlink" href="#installing-and-running-hepcloud-s-decision-engine-on-el9" title="Link to this heading"></a></h1>
<p>Currently the only version supporting EL9 is the development version, DE 2.0.x, which corresponds to the master branch in Git.</p>
<p>Decision Engine uses a PostgreSQL database back-end and Redis as message broker and cache.</p>
<p>The first one is installed as RPM requirement, the second is used as container. You need to install the pre-requisites RPM and then the Python packages for Decision Engine framework (decisionengine) and install and add the standard channels (decisionengine_modules).</p>
<p>The following instructions assume Alma Linux 9. You may need to adapt them slightly for other EL9 flavors.</p>
<p>These also assume a system installation, performed as <code class="docutils literal notranslate"><span class="pre">root</span></code>.
decisionengine will run as the decisionengine user.</p>
<section id="install-decision-engine-and-the-standard-modules">
<h2>Install Decision Engine and the standard modules<a class="headerlink" href="#install-decision-engine-and-the-standard-modules" title="Link to this heading"></a></h2>
<p>RPM installation</p>
<ol class="arabic">
<li><p>Prerequisites setup. Make sure that the required yum repositories and some required packages (python3, gcc, …) are installed and up to date.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Possible OSG versions: 24, 23, 24-upcoming</span>
<span class="n">OSG_VERSION</span><span class="o">=</span><span class="mi">24</span>
<span class="c1"># YUM repo for Decision Engine</span>
<span class="n">GWMS_REPO</span><span class="o">=</span><span class="n">osg</span><span class="o">-</span><span class="n">development</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span> <span class="n">yum</span><span class="o">-</span><span class="n">utils</span> <span class="n">sed</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enabled</span> <span class="n">crb</span>
<span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;/^enabled=1/a priority=99&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">epel</span><span class="o">.</span><span class="n">repo</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="s2">&quot;https://repo.osg-htc.org/osg/$OSG_VERSION-main/osg-$OSG_VERSION-main-el9-release-latest.rpm&quot;</span>
</pre></div>
</div>
</li>
<li><p>Setup the decision engine yum repositories</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">ssi</span><span class="o">-</span><span class="n">hepcloud</span><span class="o">.</span><span class="n">repo</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ssi</span><span class="o">-</span><span class="n">rpm</span><span class="o">.</span><span class="n">fnal</span><span class="o">.</span><span class="n">gov</span><span class="o">/</span><span class="n">hep</span><span class="o">/</span><span class="n">ssi</span><span class="o">-</span><span class="n">hepcloud</span><span class="o">.</span><span class="n">repo</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">ssi</span><span class="o">-</span><span class="n">hepcloud</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">repo</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ssi</span><span class="o">-</span><span class="n">rpm</span><span class="o">.</span><span class="n">fnal</span><span class="o">.</span><span class="n">gov</span><span class="o">/</span><span class="n">hep</span><span class="o">/</span><span class="n">ssi</span><span class="o">-</span><span class="n">hepcloud</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">repo</span>
<span class="c1"># Note the above repos are only accessible within Fermilab.  There is an alternative place on github to get the RPMs if you are off-site.</span>
</pre></div>
</div>
</li>
<li><p>Install the decision engine (add <cite>–enablerepo=ssi-hepcloud-dev</cite> for the latest development version)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DE_REPO</span><span class="o">=</span><span class="n">ssi</span><span class="o">-</span><span class="n">hepcloud</span><span class="o">-</span><span class="n">dev</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="s2">&quot;$DE_REPO&quot;</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">onenode</span>
<span class="c1"># Individual packages are: decisionengine-deps (framework req) decisionengine-modules-deps (modules req) decisionengine-standalone (2 deps+httpd)</span>
</pre></div>
</div>
</li>
<li><p>Install the required Python packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">decisionengine</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">python</span>
<span class="c1"># This will install the latest version in PyPI (hepcloud-de, hepcloud-de-modules, and all requirements)</span>
<span class="c1"># To install an arbitrary version from GitHub you can use the desired tag:</span>
<span class="n">decisionengine</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">python</span> <span class="o">--</span><span class="n">remote</span> <span class="o">--</span><span class="n">de</span><span class="o">-</span><span class="n">git</span><span class="o">-</span><span class="n">ref</span> <span class="mf">2.0.4</span>
<span class="c1"># This shell script (included in decisionengine-deps) installs the Decision Engine Python code.</span>
<span class="c1"># You can run it as root or as the decisionengine user</span>
<span class="c1"># To see all the options:  decisionengine-install-python --help</span>
<span class="c1"># Double check that pip added $HOME/.local/bin to the PATH of user decisionengine</span>
</pre></div>
</div>
</li>
<li><p>Start and enable HTCondor and httpd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">condor</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">condor</span>

<span class="n">systemctl</span> <span class="n">start</span> <span class="n">httpd</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">httpd</span>
</pre></div>
</div>
</li>
<li><p>Optionally install these extra packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># htgettoken - if you need it to generate SciTokens</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">htgettoken</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="fix-the-glideinwms-frontend-installation">
<h2>Fix the GlideinWMS Frontend installation<a class="headerlink" href="#fix-the-glideinwms-frontend-installation" title="Link to this heading"></a></h2>
<p>We will make HEPCloud’s Decision Engine using some GlideinWMS libraries but independent from the Frontend.
The codebases, though, are still intertwined, so there are some adjustments needed to the GlideinWMS installation.</p>
<p>Create the condor password and change to decisionengine the ownership of the frontend directories:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">decisionengine</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">gwms</span><span class="o">-</span><span class="n">frontend</span>

<span class="c1"># Create or copy the FRONTEND condor password file</span>
<span class="c1"># If POOL is not there, do start condor (systemctl start condor)</span>
<span class="n">pushd</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">condor</span><span class="o">/</span><span class="n">passwords</span><span class="o">.</span><span class="n">d</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">POOL</span> <span class="n">FRONTEND</span>
<span class="n">cp</span> <span class="n">FRONTEND</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gwms</span><span class="o">-</span><span class="n">frontend</span><span class="o">/</span><span class="n">passwords</span><span class="o">.</span><span class="n">d</span><span class="o">/</span>
<span class="n">popd</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">decisionengine</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gwms</span><span class="o">-</span><span class="n">frontend</span>
<span class="c1"># The permission of /var/lib/gwms-frontend/passwords.d/FRONTEND should be 0600</span>
</pre></div>
</div>
</section>
<section id="set-up-postgresql">
<h2>Set up PostgreSQL<a class="headerlink" href="#set-up-postgresql" title="Link to this heading"></a></h2>
<p>PostgreSQL is installed by the requirements RPM, Postgresql 13:</p>
<ol class="arabic">
<li><p>Enable postgresql</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">postgresql</span>
</pre></div>
</div>
</li>
<li><p>Init the database</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">postgresql</span><span class="o">-</span><span class="n">setup</span> <span class="o">--</span><span class="n">initdb</span>
</pre></div>
</div>
</li>
<li><p>edit <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/pg_hba.conf</span></code> like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@fermicloud371</span> <span class="o">~</span><span class="p">]</span><span class="c1"># diff  /var/lib/pgsql/data/pg_hba.conf~ /var/lib/pgsql/data/pg_hba.conf</span>
<span class="mi">80</span><span class="n">c80</span>
<span class="o">&lt;</span> <span class="n">local</span>   <span class="nb">all</span>             <span class="nb">all</span>                                     <span class="n">peer</span>
<span class="o">---</span>
<span class="o">&gt;</span> <span class="n">local</span>   <span class="nb">all</span>             <span class="nb">all</span>                                     <span class="n">trust</span>
<span class="mi">82</span><span class="n">c82</span>
<span class="o">&lt;</span> <span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">32</span>            <span class="n">ident</span>
<span class="o">---</span>
<span class="o">&gt;</span> <span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">32</span>            <span class="n">trust</span>
<span class="mi">84</span><span class="n">c84</span>
<span class="o">&lt;</span> <span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="p">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span>                 <span class="n">ident</span>
<span class="o">---</span>
<span class="o">&gt;</span> <span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="p">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span>                 <span class="n">trust</span>
</pre></div>
</div>
<p>(difference of the correct file from the default one - <cite>pg_hba.conf~</cite>)
This is setting the authentication method to <cite>trust</cite></p>
</li>
<li><p>Fix the PostgreSQL installation. Not sure why, but the run directory was missing and causing the startup to fail.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Without this the systemctl start was failing and the error was in /var/lib/pgsql/data/log/postgresql-*.log</span>
</pre></div>
</div>
<p>mkdir -p /var/run/postgresql
chown postgres: /var/run/postgresql</p>
</li>
<li><p>start the database</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">postgresql</span>
</pre></div>
</div>
</li>
<li><p>create decisionengine</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">createdb</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">decisionengine</span>
</pre></div>
</div>
</li>
</ol>
<p>The schema and the connection will be created and configured during the Decision Engine framework initialization.</p>
<p>RHEL also provides other PostgreSQL versions via streams. These may require changes to environment variables like PG_VERSION and PATH to use the database.</p>
</section>
<section id="install-redis">
<h2>Install Redis<a class="headerlink" href="#install-redis" title="Link to this heading"></a></h2>
<p>Install and start the message broker (Redis) container on your system. You can find more details on the <a class="reference internal" href="redis.html"><span class="doc">redis document</span></a></p>
<ol class="arabic">
<li><p>You may need to fix the firewall used</p>
<p>dnf rm iptables-legacy
dnf install iptables-nft</p>
</li>
<li><p>Install Padman</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">podman</span>
</pre></div>
</div>
</li>
<li><p>Run the Redis container</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">podman</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">redis</span> <span class="o">-</span><span class="n">p</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span> <span class="o">-</span><span class="n">d</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span> <span class="o">--</span><span class="n">loglevel</span> <span class="n">warning</span>
<span class="c1"># When prompted to select an image, pick &quot;docker.io/library/redis:6&quot;.</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="test">
<h2>Test<a class="headerlink" href="#test" title="Link to this heading"></a></h2>
<p>Now you can type <code class="docutils literal notranslate"><span class="pre">decisionengine</span> <span class="pre">--help</span></code> while logged in as decisionengine to print the help message.
To do more you need first to configure Decision Engine.</p>
<p>Remember that all the times that you start a new shell as decisionengine you need to add the PIP binary directory to the PATH:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;~/.local/bin:$PATH&quot;</span>
</pre></div>
</div>
</section>
<section id="configure-decision-engine">
<h2>Configure Decision Engine<a class="headerlink" href="#configure-decision-engine" title="Link to this heading"></a></h2>
<p>The default configuration file lives in <code class="docutils literal notranslate"><span class="pre">/etc/decisionengine/decision_engine.jsonnet</span></code>.</p>
<p>A number of defaults are set for you.</p>
<section id="selecting-your-datasource">
<h3>Selecting your datasource<a class="headerlink" href="#selecting-your-datasource" title="Link to this heading"></a></h3>
<p>You need a datasource to store in the database the channel’s data (datablocks).
Each datasource has its own unique schema and cannot be used with a different datasource.</p>
<p><strong>The SQLAlchemy Data Source</strong></p>
<p>SQLAlchemy is the default Data Source and is setup with a configuration like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;datasource&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;decisionengine.framework.dataspace.datasources.sqlalchemy_ds&quot;</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;SQLAlchemyDS&quot;</span><span class="p">,</span>
  <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;postgresql://</span><span class="si">{db_user}</span><span class="s2">:</span><span class="si">{db_password}</span><span class="s2">@</span><span class="si">{db_host}</span><span class="s2">:</span><span class="si">{db_port}</span><span class="s2">/</span><span class="si">{db_dbname}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Any extra keywords you can pass to the <code class="docutils literal notranslate"><span class="pre">sqlalchemy.engine.Engine</span></code> constructor may be set under <code class="docutils literal notranslate"><span class="pre">config</span></code>.</p>
<p>SQLAlchemy will create any tablespace objects it requires automatically.</p>
<p>The PostgreSQL data source, used until v1.7, is no more supported.</p>
</section>
</section>
<section id="start-decision-engine">
<h2>Start decision engine<a class="headerlink" href="#start-decision-engine" title="Link to this heading"></a></h2>
<p>Start the service</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For the RPM install, as root:</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">decisionengine</span>
<span class="c1"># For the PIP install, as decisionengine user (Python packages are installed in ~decisionengine/.local/bin/):</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;~/.local/bin:$PATH&quot;</span>
<span class="n">decisionengine</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">webserver</span> <span class="o">&amp;</span>
</pre></div>
</div>
</section>
<section id="stop-decision-engine">
<h2>Stop decision engine<a class="headerlink" href="#stop-decision-engine" title="Link to this heading"></a></h2>
<p>To stop the service and remove the Redis container once you are done run the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you are in a RPM installation, as root:</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">decisionengine</span>
<span class="c1"># If you installed via PIP, as decisionengine:</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;~/.local/bin:$PATH&quot;</span>
<span class="n">de</span><span class="o">-</span><span class="n">client</span> <span class="o">--</span><span class="n">stop</span>
<span class="c1"># Run the following as root (root started the container)</span>
<span class="n">podman</span> <span class="n">stop</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">redis</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">podman</span> <span class="n">rm</span>
</pre></div>
</div>
</section>
<section id="add-channels-to-decision-engine">
<h2>Add channels to decision engine<a class="headerlink" href="#add-channels-to-decision-engine" title="Link to this heading"></a></h2>
<p>Decision engine decision cycles happen in channels.
You can add channels by adding configuration files in <code class="docutils literal notranslate"><span class="pre">/etc/decisionengine/config.d/</span></code>
and restarting the decision engine.</p>
<p>Here is a simple test channel configuration.
This test channel is using some NOP classes currently defined in the unit tests and not distributed.</p>
<p>The following configuration has been added as an example to <code class="docutils literal notranslate"><span class="pre">/etc/decisionengine/config.d/test_channel.jsonnet</span></code> during the installation process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="n">sources</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">source1</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">module</span><span class="p">:</span> <span class="s2">&quot;decisionengine.framework.tests.SourceNOP&quot;</span><span class="p">,</span>
      <span class="n">parameters</span><span class="p">:</span> <span class="p">{},</span>
      <span class="n">schedule</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">transforms</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">transform1</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">module</span><span class="p">:</span> <span class="s2">&quot;decisionengine.framework.tests.TransformNOP&quot;</span><span class="p">,</span>
      <span class="n">parameters</span><span class="p">:</span> <span class="p">{},</span>
      <span class="n">schedule</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">logicengines</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">le1</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">module</span><span class="p">:</span> <span class="s2">&quot;decisionengine.framework.logicengine.LogicEngine&quot;</span><span class="p">,</span>
      <span class="n">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">facts</span><span class="p">:</span> <span class="p">{</span>
          <span class="n">pass_all</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span>
        <span class="p">},</span>
        <span class="n">rules</span><span class="p">:</span> <span class="p">{</span>
          <span class="n">r1</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">expression</span><span class="p">:</span> <span class="s1">&#39;pass_all&#39;</span><span class="p">,</span>
            <span class="n">actions</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;publisher1&#39;</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">publishers</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">publisher1</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">module</span><span class="p">:</span> <span class="s2">&quot;decisionengine.framework.tests.PublisherNOP&quot;</span><span class="p">,</span>
      <span class="n">parameters</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, start or restart decision engine to start the new channel:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For the RPM install:</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">decisionengine</span>
<span class="c1"># For the PIP install, as decisionengine user</span>
<span class="n">decisionengine</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">webserver</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Once the decisionengine is running, <code class="docutils literal notranslate"><span class="pre">de-client</span> <span class="pre">--status</span></code> should show the active test channel.</p>
</section>
<section id="setup-pressure-based-pilot-submission">
<h2>Setup pressure-based pilot submission<a class="headerlink" href="#setup-pressure-based-pilot-submission" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">At this point Decision Engine, GlideinWMS and HTCondor are supposed to be installed and able to run.</div>
<div class="line">We assume that the Frontend proxy and the VO proxy are already available.</div>
<div class="line"><br /></div>
</div>
<p><strong>- Configure the pressure-based submission</strong>
| Write the configuration for the Decision Engine glideinwms module
| To ease the process you can use the templates available in the <a class="reference external" href="https://github.com/HEPCloud/contrib/tree/master/config_template">config_template contrib repo</a>.
| Copy the files from the <code class="docutils literal notranslate"><span class="pre">EL9</span></code> folder into <code class="docutils literal notranslate"><span class="pre">/etc/decisionengine</span></code>, and the files in <code class="docutils literal notranslate"><span class="pre">EL9/config.d/</span></code> into <code class="docutils literal notranslate"><span class="pre">/etc/decisionengine/config.d</span></code>.
| If you made changes to <code class="docutils literal notranslate"><span class="pre">decision_engine.jsonnet</span></code> please merge it with the version form the repository.
| The important part  from the is the glideinwms import <code class="docutils literal notranslate"><span class="pre">decision_engine.jsonnet</span></code> template is the line: <code class="docutils literal notranslate"><span class="pre">glideinwms:</span> <span class="pre">import</span> <span class="pre">'glideinwms.libsonnet',</span></code>.
| Those configuration files have a placeholder field <code class="docutils literal notranslate"><span class="pre">&#64;TEMPLATE...&#64;</span></code>
| that needs to be replaced with the proper parameters according to your specific system setup. The README file has some suggestions.</p>
<p>Once those configuration files have been updated, we are ready to finalize the Decision Engine configuration.</p>
<p><strong>- Setup Redis</strong></p>
<p>Start the message broker (Redis) as pod container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">podman</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">redis</span> <span class="o">-</span><span class="n">p</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span> <span class="o">-</span><span class="n">d</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span> <span class="o">--</span><span class="n">loglevel</span> <span class="n">warning</span>
</pre></div>
</div>
<p><strong>- Create GWMS frontend configuration</strong>
For this step you need first to restart the Decision Engine and then to run a configuration script. To do so, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># as root (fix the ownership of the frontend library files)</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">decisionengine</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gwms</span><span class="o">-</span><span class="n">frontend</span>
<span class="c1"># for RPM installation as root</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">decisionengine</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">decisionengine</span>
<span class="n">ksu</span> <span class="n">decisionengine</span> <span class="o">-</span><span class="n">e</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">decisionengine_modules</span><span class="o">/</span><span class="n">glideinwms</span><span class="o">/</span><span class="n">configure_gwms_frontend</span><span class="o">.</span><span class="n">py</span>
<span class="c1"># for PIP installation as decisionengine</span>
<span class="n">de</span><span class="o">-</span><span class="n">client</span> <span class="o">--</span><span class="n">stop</span>
<span class="n">decisionengine</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">webserver</span> <span class="o">&amp;</span>
<span class="n">python3</span> <span class="o">~</span><span class="n">decisionengine</span><span class="o">/</span><span class="n">decisionengine_modules</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">decisionengine_modules</span><span class="o">/</span><span class="n">glideinwms</span><span class="o">/</span><span class="n">configure_gwms_frontend</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This command will create the file <code class="docutils literal notranslate"><span class="pre">/var/lib/gwms-frontend/vofrontend/de_frontend_config</span></code></p>
<p>To allow a fresh start stop and reset everything:</p>
<ol class="arabic simple">
<li><p>stop the decisionengine (service):</p></li>
</ol>
<blockquote>
<div><p># If you are in a RPM installation, as root:
systemctl stop decisionengine
# If you installed via PIP, as decisionengine:
de-client –stop</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>remove the Redis container:</p></li>
</ol>
<blockquote>
<div><p># Run the following as root (root started the container)
podman stop decisionengine-redis | xargs podman rm</p>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>and reset the decisionengine DB in PostgreSQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dropdb</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">decisionengine</span>
<span class="n">createdb</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="n">decisionengine</span>
</pre></div>
</div>
</li>
</ol>
<p><strong>- Run Decision Engine</strong>
Now all should be ready to run Decision Engine with a fresh start.
Start the Redis container and the decisionengine service.</p>
<ul>
<li><p>Run Redis container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">podman</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">redis</span> <span class="o">-</span><span class="n">p</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span> <span class="o">-</span><span class="n">d</span> <span class="n">redis</span><span class="p">:</span><span class="mi">6</span> <span class="o">--</span><span class="n">loglevel</span> <span class="n">warning</span>
</pre></div>
</div>
</li>
<li><p>Start decisionengine service and check its status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For RPM installations as root:</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">decisionengine</span>
<span class="n">sleep</span> <span class="mi">5</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">decisionengine</span>
<span class="c1"># For PIP installations as decisionengine:</span>
<span class="n">decisionengine</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">webserver</span> <span class="o">&amp;</span>
<span class="n">sleep</span> <span class="mi">5</span>
<span class="n">de</span><span class="o">-</span><span class="n">client</span> <span class="o">--</span><span class="n">status</span>
</pre></div>
</div>
</li>
</ul>
<p><strong>- Submit a test job</strong>
Finally you can submit a test job to trigger Glidein requests and test the system.</p>
<ul>
<li><p>Switch to <code class="docutils literal notranslate"><span class="pre">decisionengine</span></code> user and make sure channel and sources are <code class="docutils literal notranslate"><span class="pre">STEADY</span></code>:</p>
<p>ksu decisionengine -e /bin/bash
de-client –status</p>
</li>
<li><p>prepare a Condor submission file <code class="docutils literal notranslate"><span class="pre">mytest.submit</span></code> with the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#  A test Condor submission file - mytest.submit
executable = /bin/hostname
universe = vanilla
+DESIRED_Sites = &quot;@CHANGEME@&quot;
log = test.log
output = test.out.$(Cluster).$(Process)
error = test.err.$(Cluster).$(Process)
queue 1
</pre></div>
</div>
</li>
<li><p>submit the test job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">condor_submit</span> <span class="n">mytest</span><span class="o">.</span><span class="n">submit</span>
</pre></div>
</div>
</li>
<li><p>check jobs in the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">condor_q</span>
</pre></div>
</div>
</li>
<li><p>check for available glideins:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">condor_status</span>
</pre></div>
</div>
</li>
</ul>
<p>after test jobs are submitted it will take few minutes (usually no more than 10 minutes) to get some glideins and then get the job running.</p>
<p>Now the <code class="docutils literal notranslate"><span class="pre">decisionengine</span></code> user session can be closed to get back to the <code class="docutils literal notranslate"><span class="pre">root</span></code> session.</p>
<p><strong>- Stop Decision Engine service</strong></p>
<p>Finally stop Decision Engine service and remove the Redis container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you installed via RPMs run</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">decisionengine</span><span class="o">.</span><span class="n">service</span>
<span class="c1"># Run de-client --stop as decisionengine if you installed w/ PIP</span>
<span class="n">podman</span> <span class="n">stop</span> <span class="n">decisionengine</span><span class="o">-</span><span class="n">redis</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">podman</span> <span class="n">rm</span>
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<p>There is a known podman bug.
<code class="docutils literal notranslate"><span class="pre">podman</span></code> is leaking volumes each time it starts a container, in the long run this is exhausting system resources.
To check current volumes used by podman user can run <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">volume</span> <span class="pre">list</span></code>.
To clean up volumes user can run <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">volume</span> <span class="pre">prune</span> <span class="pre">-f</span></code> after all podman container have been stopped and removed.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="release_notes/release_notes_1.1.html" class="btn btn-neutral float-left" title="Release 1.1.0" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="install_el7.html" class="btn btn-neutral float-right" title="Installing and running HEPCloud’s Decision Engine" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Fermilab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>